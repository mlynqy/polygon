import os
import sqlite3
import requests
from telegram import Update
from telegram.ext import Updater, CommandHandler, CallbackContext, MessageHandler, filters

# === é…ç½® ===
TELEGRAM_TOKEN = 'token'
POLYGONSCAN_API_KEY = 'key'
DB_FILE = 'db.sqlite3'
CHECK_INTERVAL = 30

# === åˆå§‹åŒ–æ•°æ®åº“ ===
def init_db():
    conn = sqlite3.connect(DB_FILE)
    c = conn.cursor()
    c.execute('''
        CREATE TABLE IF NOT EXISTS bindings (
            chat_id INTEGER NOT NULL,
            address TEXT NOT NULL,
            remark TEXT,
            last_tx TEXT,
            PRIMARY KEY (chat_id, address)
        )
    ''')
    # å°è¯•æ·»åŠ  remark å­—æ®µï¼ˆæ—§ç”¨æˆ·å…¼å®¹ï¼‰
    try:
        c.execute("ALTER TABLE bindings ADD COLUMN remark TEXT")
    except:
        pass
    conn.commit()
    conn.close()

def get_db_conn():
    return sqlite3.connect(DB_FILE)

# === /start ===
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ Polygon Bot\n"
        "ğŸ§¾ å¯ç”¨å‘½ä»¤ï¼š\n"
        "/ç»‘å®š <åœ°å€> <å¤‡æ³¨> ç»‘å®šåœ°å€\n"
        "/è§£ç»‘ <åœ°å€> åˆ é™¤ç»‘å®š\n"
        "/æˆ‘çš„ç»‘å®š æŸ¥çœ‹å·²ç»‘å®šåœ°å€"
    )

# === /ç»‘å®š <åœ°å€> <å¤‡æ³¨> ===
def bind_address(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    if len(context.args) < 1:
        update.message.reply_text("âŒ ç”¨æ³•é”™è¯¯ï¼š/ç»‘å®š <åœ°å€> <å¤‡æ³¨>")
        return

    address = context.args[0].lower()
    remark = " ".join(context.args[1:]) if len(context.args) > 1 else ""

    conn = get_db_conn()
    c = conn.cursor()
    c.execute('''
        INSERT OR REPLACE INTO bindings (chat_id, address, remark)
        VALUES (?, ?, ?)
    ''', (chat_id, address, remark))
    conn.commit()
    conn.close()

    update.message.reply_text(f"âœ… å·²ç»‘å®šåœ°å€ï¼š{address}\nğŸ“Œ å¤‡æ³¨ï¼š{remark}")

# === /è§£ç»‘ <åœ°å€> ===
def unbind_address(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    if len(context.args) != 1:
        update.message.reply_text("âŒ ç”¨æ³•é”™è¯¯ï¼š/è§£ç»‘ <åœ°å€>")
        return

    address = context.args[0].lower()
    conn = get_db_conn()
    c = conn.cursor()
    c.execute('DELETE FROM bindings WHERE chat_id = ? AND address = ?', (chat_id, address))
    conn.commit()
    affected = c.rowcount
    conn.close()

    if affected:
        update.message.reply_text(f"âœ… å·²è§£ç»‘åœ°å€ï¼š{address}")
    else:
        update.message.reply_text(f"âš ï¸ æœªæ‰¾åˆ°ç»‘å®šï¼š{address}")

# === /æˆ‘çš„ç»‘å®š ===
def list_bindings(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    conn = get_db_conn()
    c = conn.cursor()
    c.execute('SELECT address, remark FROM bindings WHERE chat_id = ?', (chat_id,))
    rows = c.fetchall()
    conn.close()

    if not rows:
        update.message.reply_text("ğŸ“­ å½“å‰æ— ç»‘å®š")
        return

    msg = "ğŸ“¦ å½“å‰ç»‘å®šåœ°å€ï¼š\n\n"
    for addr, remark in rows:
        msg += f"ğŸ”— {addr}\nğŸ“ {remark or 'æ— å¤‡æ³¨'}\n\n"
    update.message.reply_text(msg)

# === æŸ¥è¯¢åœ°å€æœ€æ–°äº¤æ˜“ ===
def get_latest_tx(address):
    url = (
        f'https://api.polygonscan.com/api'
        f'?module=account&action=txlist&address={address}'
        f'&startblock=0&endblock=99999999&sort=desc&apikey={POLYGONSCAN_API_KEY}'
    )
    try:
        res = requests.get(url, timeout=10)
        data = res.json()
        if data.get('status') != '1':
            return None
        return data['result'][0]
    except:
        return None

# === å®šæ—¶è½®è¯¢äº¤æ˜“ ===
def check_all_transactions(context: CallbackContext):
    conn = get_db_conn()
    c = conn.cursor()
    c.execute('SELECT chat_id, address, remark, last_tx FROM bindings')
    rows = c.fetchall()

    for chat_id, address, remark, last_tx in rows:
        tx = get_latest_tx(address)
        if not tx: continue

        tx_hash = tx['hash']
        if tx_hash == last_tx:
            continue  # è·³è¿‡é‡å¤

        value = int(tx['value']) / 1e18
        from_addr = tx['from'].lower()
        to_addr = tx['to'].lower()
        direction = 'ğŸ“¥ å…¥è´¦' if to_addr == address.lower() else 'ğŸ“¤ å‡ºè´¦'
        sign = '+' if direction == 'ğŸ“¥ å…¥è´¦' else '-'

        label = f"{remark} ({address})" if remark else address
        msg = (
            f"ğŸ“¢ [{label}] æœ‰æ–°äº¤æ˜“\n"
            f"{direction}: {sign}{value:.4f} MATIC\n"
            f"ğŸ”‘ äº¤æ˜“å“ˆå¸Œ: {tx_hash}"
        )
        try:
            context.bot.send_message(chat_id=chat_id, text=msg)
        except Exception as e:
            print(f"âŒ å‘é€å¤±è´¥: {e}")

        c.execute('UPDATE bindings SET last_tx = ? WHERE chat_id = ? AND address = ?', (tx_hash, chat_id, address))

    conn.commit()
    conn.close()

# === ä¸»å‡½æ•° ===
def main():
    init_db()
    updater = Updater(TELEGRAM_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("ç»‘å®š", bind_address))
    dp.add_handler(CommandHandler("è§£ç»‘", unbind_address))
    dp.add_handler(CommandHandler("æˆ‘çš„ç»‘å®š", list_bindings))
    dp.add_handler(MessageHandler(filters.text & ~filters.command, lambda u, c: u.message.reply_text("â“ æœªè¯†åˆ«æŒ‡ä»¤")))

    updater.job_queue.run_repeating(check_all_transactions, interval=CHECK_INTERVAL, first=5)
    print("âœ… Bot å·²å¯åŠ¨")
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
